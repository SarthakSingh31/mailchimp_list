<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Mailchimp list</title>
    </head>
    <body>
        <button id="sync">Sync</button>
        <div id="campaigns">
        </div>
        <ul id="add-videos">
        </ul>
        <script>
            const LOGIN_URL = "{LOGIN_URL}";

            if (localStorage.getItem("session-id") == null) {
                window.location.replace(LOGIN_URL);
            } else {
                fetch(`/validate_session?session_id=${localStorage.getItem("session-id")}`)
                    .then((resp) => {
                        if (resp.status >= 400) {
                            window.location.replace(LOGIN_URL);
                        }
                    });

                const ADD_VIDEOS = document.getElementById("add-videos");

                fetch("/campaigns", {
                    headers: { "session-id": localStorage.getItem("session-id") },
                })
                .then((resp) => resp.json())
                .then((campaigns) => {
                    campaigns.campaigns.forEach((campaign) => {
                        let c_elm = document.createElement("li");

                        let span_elm = document.createElement("span");
                        span_elm.innerText = campaign.settings.title;
                        c_elm.appendChild(span_elm);

                        let tag_elm = document.createElement("span");

                        let add_btn = document.createElement("button");
                        add_btn.innerText = "Add";
                        add_btn.onclick = (evt) => {
                            evt.preventDefault();

                            fetch(`/populate_merge_fields/${campaign.id}`, {
                                method: "POST",
                                headers: { "session-id": localStorage.getItem("session-id") },
                            })
                            .then((resp) => resp.json())
                            .then((data) => {
                                tag_elm.innerText = `Please use merge field tag "*|${data.tag}|*" to embed the video`;
                            });
                        };
                        c_elm.appendChild(add_btn);

                        c_elm.appendChild(tag_elm);

                        ADD_VIDEOS.appendChild(c_elm);
                    });
                });

                const CAMPAIGNS = document.getElementById("campaigns");

                document.getElementById("sync").onclick = (evt) => {
                    CAMPAIGNS.innerHTML = '';

                    fetch("/sync", {
                        method: "POST",
                        headers: { "session-id": localStorage.getItem("session-id") },
                    })
                    .then((resp) => resp.json())
                    .then((new_data) => {
                        new_data.forEach(campaign => {
                            let c_elm = document.createElement("div");

                            let c_inner_elm = document.createElement("span");
                            c_inner_elm.innerText = campaign.title;
                            c_elm.append(c_inner_elm);

                            if (campaign.new_members.length == 0) {
                                let m_elm = document.createElement("div");
                                m_elm.innerText = "No new emails";

                                c_elm.append(m_elm);
                            } else {
                                let ul_elm = document.createElement("ul");
                                c_elm.append(ul_elm);

                                campaign.new_members.forEach(member => {
                                    let m_elm = document.createElement("li");
                                    m_elm.innerText = `${member.full_name}: ${member.email_address}`;
                        
                                    ul_elm.append(m_elm);
                                });
                            }
                            
                            CAMPAIGNS.append(c_elm);
                        });
                    });
                };
            }
        </script>
    </body>
</html>