<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Mailchimp list</title>
    </head>
    <body>
        <button id="sync">Sync</button>
        <div id="campaigns">
        </div>
        <script>
            const LOGIN_URL = "{LOGIN_URL}";
            const CAMPAIGNS = document.getElementById("campaigns");

            if (localStorage.getItem("session-id") == null) {
                window.location.replace(LOGIN_URL);
            } else {
                fetch(`/validate_session?session_id=${localStorage.getItem("session-id")}`)
                    .then((resp) => {
                        if (resp.status >= 400) {
                            window.location.replace(LOGIN_URL);
                        }
                    });

                document.getElementById("sync").onclick = (evt) => {
                    CAMPAIGNS.innerHTML = '';

                    fetch("/sync", {
                        method: "POST",
                        headers: { "session-id": localStorage.getItem("session-id") },
                    })
                    .then((resp) => resp.json())
                    .then((new_data) => {
                        new_data.forEach(campaign => {
                            let c_elm = document.createElement("div");

                            let c_inner_elm = document.createElement("span");
                            c_inner_elm.innerText = campaign.title;
                            c_elm.append(c_inner_elm);

                            if (campaign.new_members.length == 0) {
                                let m_elm = document.createElement("div");
                                m_elm.innerText = "No new emails";

                                c_elm.append(m_elm);
                            } else {
                                let ul_elm = document.createElement("ul");
                                c_elm.append(ul_elm);

                                campaign.new_members.forEach(member => {
                                    let m_elm = document.createElement("li");
                                    m_elm.innerText = `${member.full_name}: ${member.email_address}`;
                        
                                    ul_elm.append(m_elm);
                                });
                            }
                            
                            CAMPAIGNS.append(c_elm);
                        });
                    });
                };
            }
        </script>
    </body>
</html>